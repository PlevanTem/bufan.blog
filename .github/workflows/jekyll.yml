name: Build and Deploy to Github Pages

on:
  push:
    branches:
      - master

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest  # 修复1：单平台部署（避免跨平台证书问题）
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true  # 修复2：确保获取主题子模块

      # 修复3：使用Docker构建（最可靠解决方案，完全绕过证书问题）
      - name: Build with Docker
        run: |
          docker run --rm \
            -v "$PWD:/srv/jekyll" \
            -w /srv/jekyll \
            -e JEKYLL_ENV=production \
            jekyll/jekyll:4.3.0 \
            jekyll build --future

      # 修复4：健康检查（验证构建结果）
      - name: Verify Build Results
        run: |
          echo "Checking generated site..."
          [ -f _site/index.html ] || (echo "Build failed: index.html not found" && exit 1)
          grep -q "<html" _site/index.html || (echo "Build failed: invalid HTML" && exit 1)
          echo "Build successful!"

      # 修复5：简化部署（使用官方GitHub Action）
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
          keep_files: false  # 清理旧文件，避免残留
          force_orphan: true # 创建干净提交