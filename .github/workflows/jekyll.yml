name: Build and Deploy to Github Pages

on:
  push:
    branches:
      - master  # Here source code branch is `master`, it could be other branch

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4  # 拉取代码

      - name: Update CA certificates  # 解决SSL证书问题
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ca-certificates  # 安装最新根证书
          sudo update-ca-certificates --fresh      # 强制刷新证书缓存（核心）

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.2.0
          bundler-cache: false  # 关键：禁用旧缓存，避免覆盖新锁文件

      # 关键步骤1：添加 Linux 平台支持到锁文件
      - name: Add Linux platform to Gemfile.lock  
        run: bundle lock --add-platform x86_64-linux
      
      # 再安装依赖（此时会生成适配 Linux 的依赖）
      - name: Install dependencies
        run: bundle install --jobs 4 --retry 3
      
      # 关键步骤2：指定 SSL_CERT_FILE 环境变量
      - name: Download updated cacert.pem
        run: curl -o cacert.pem https://curl.se/ca/cacert.pem

      # 关键步骤3：构建时同样指定SSL证书路径
      - name: Build site with SSL cert
        env:
          SSL_CERT_FILE: ${{ github.workspace }}/cacert.pem
        run: |
          export SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt # 明确告诉Ruby系统CA证书的位置
          bundle exec jekyll build --trace  # 保留--trace方便调试
      
      # Use GitHub Actions' cache to cache dependencies on servers
      - uses: actions/cache@v4
        with:
          path: |
            .asdf/**
            vendor/bundle
          key: ${{ runner.os }}-cache-${{ hashFiles('**/cache.key') }}
          restore-keys: |
            ${{ runner.os }}-cache-

      # Use GitHub Deploy Action to build and deploy to Github
      # For latest version: `jeffreytse/jekyll-deploy-action@master`
      - uses: jeffreytse/jekyll-deploy-action@v0.6.0
        with:
          provider: 'github'         # Default is github
          token: ${{ secrets.GITHUB_TOKEN }} # It's your Personal Access Token(PAT)
          # ssh_private_key: 'SHA256:oy4HWcUUT/5bzOLaxSsOoUu8rQnhZ+zhhDUClCW1u60'        # 使用内置的GITHUB_TOKEN（无需手动配置PAT） It's your SSH private key (SSH approach)
          repository: ''             # Default is current repository
          branch: 'gh-pages'         # Default is gh-pages for github provider
          jekyll_src: './'           # Default is root directory
          jekyll_cfg: '_config.yml'  # Default is _config.yml
          jekyll_baseurl: ''         # Default is according to _config.yml
          ruby_ver: ''               # Default is 3.2.0 version
          bundler_ver: ''            # Default is compatible bundler version (~>2.5.0)
          cname: ''                  # Default is to not use a cname
          actor: ''                  # Default is the GITHUB_ACTOR
          pre_build_commands: ''     # Installing additional dependencies (Arch Linux)
          args: '--trace'  # 新增这一行，让 Jekyll 输出详细错误日志